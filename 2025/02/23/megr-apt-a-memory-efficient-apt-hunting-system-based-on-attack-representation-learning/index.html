<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    Blogs of Bin
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="miccall" />
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 7.3.0"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">Spark</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">Home</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">Categories</a>
	                    <ul class="submenu">
	                        <li>
	                        
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="About">
		                About
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="Tags">
		                Tags
		            </a>
		        </li>
		        
		        <li>
		            <a href="/works/" title="Works">
		                Works
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/sparkfyb" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url();background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >阅文乐己: MEGR-APT: A Memory-Efficient APT Hunting System Based on Attack Representation Learning</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h1>MEGR-APT: A Memory-Efficient APT Hunting System Based on Attack Representation Learning</h1>
<p><em>Year: 2024, Author: Department of Computer Science and Software Engineering, Concordia University</em></p>
<h2 id="Abstract：">Abstract：</h2>
<blockquote>
<p>The stealthy and persistent nature of Advanced Persistent Threats (APTs) makes them one of the most challenging cyber threats to uncover. Several systems adopted the development of provenance-graph-based security solutions to capture this persistent nature. Provenance graphs (PGs) represent system audit logs by connecting system entities using causal relations and information flows. Hunting APTs demands the processing of ever-growing large-scale PGs of audit logs for a wide range of activities over months or years, i.e., multiterabyte graphs. Existing APT hunting systems are typically memory-based, which suffers colossal memory consumption, or disk-based, which suffers from performance hits. Therefore, these systems are hard to scale in terms of graph size or time performance. In this paper, we propose MEGR-APT, a scalable APT hunting system to discover suspicious subgraphs matching an attack scenario (query graph) published in Cyber Threat Intelligence (CTI) reports. MEGR-APT hunts APTs in a twofold process: (i) memory-efficient extraction of suspicious subgraphs as search queries over a graph database, and (ii) fast subgraph matching based on graph neural network (GNN) and our effective attack representation learning. We compared MEGR-APT with state-of-the-art (SOTA) APT systems using popular APT benchmarks, such as DARPA TC3 and OpTC. We also tested it using a real enterprise dataset. MEGR-APT achieves an order of magnitude reduction in memory consumption while achieving comparable performance to SOTA in terms of time and accuracy.</p>
</blockquote>
<h2 id="Record">Record:</h2>
<p>一般情况下，我看到好的论文才会单独开一版，而这篇我实际上还没看；<br>
但奈何这篇有源码，赢太多了。<br>
首先需要说明的，也就是我目前最需要的，DARPA TC E3 数据集的溯源图构建；基于这篇论文对TA1-cadets处理的源码（对数据本身的探索详情请见博客内文章Dataset of CyberSecurity的DARPA TC部分），讨论具体的内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    </span><br><span class="line">    provenance_graph_name = <span class="string">&quot;attack_BSD_1_provenance_graph&quot;</span></span><br><span class="line">    provenance_graph_start = <span class="number">1522718400000000000</span></span><br><span class="line">    provenance_graph_end = <span class="number">1523042400000000000</span></span><br><span class="line">    build_graph(provenance_graph_name,provenance_graph_start,provenance_graph_end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n*************************************\n&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    provenance_graph_name = <span class="string">&quot;attack_BSD_2_provenance_graph&quot;</span></span><br><span class="line">    provenance_graph_start = <span class="number">1523042400000000000</span></span><br><span class="line">    provenance_graph_end = <span class="number">1523478900000000000</span></span><br><span class="line">    build_graph(provenance_graph_name,provenance_graph_start,provenance_graph_end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n*************************************\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    provenance_graph_name = <span class="string">&quot;attack_BSD_3&amp;4_provenance_graph&quot;</span></span><br><span class="line">    provenance_graph_start = <span class="number">1523478900000000000</span></span><br><span class="line">    provenance_graph_end = <span class="number">1523655358953968696</span></span><br><span class="line">    build_graph(provenance_graph_name,provenance_graph_start,provenance_graph_end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n*************************************\n&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    provenance_graph_name = <span class="string">&quot;benign_BSD_provenance_graph&quot;</span></span><br><span class="line">    provenance_graph_start = <span class="number">1522706861813350340</span></span><br><span class="line">    provenance_graph_end = <span class="number">1522990800000000000</span></span><br><span class="line">    build_graph(provenance_graph_name,provenance_graph_start,provenance_graph_end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n*************************************\n&quot;</span>)</span><br><span class="line">```   </span><br><span class="line">文章首先将整个的运行流程划分为四个时间段，转换之后其分别对应了：</span><br><span class="line">```python</span><br><span class="line">[(<span class="string">&#x27;2018-04-02T21:20:00-04:00&#x27;</span>, <span class="string">&#x27;2018-04-06T15:20:00-04:00&#x27;</span>),</span><br><span class="line"> (<span class="string">&#x27;2018-04-06T15:20:00-04:00&#x27;</span>, <span class="string">&#x27;2018-04-11T16:35:00-04:00&#x27;</span>),</span><br><span class="line"> (<span class="string">&#x27;2018-04-11T16:35:00-04:00&#x27;</span>, <span class="string">&#x27;2018-04-13T17:35:58-04:00&#x27;</span>),</span><br><span class="line"> (<span class="string">&#x27;2018-04-02T18:07:41-04:00&#x27;</span>, <span class="string">&#x27;2018-04-06T01:00:00-04:00&#x27;</span>)]</span><br></pre></td></tr></table></figure>
<p>接下来我们看<code>build_graph</code>中是如何构建图的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">df_events = pd.read_sql(query_events,db_url,</span><br><span class="line">    params=&#123;<span class="string">&quot;start_timestamp&quot;</span>:provenance_graph_start,<span class="string">&quot;end_timestamp&quot;</span>:provenance_graph_end&#125;)</span><br><span class="line">df_events[<span class="string">&#x27;type&#x27;</span>] = [event.split(<span class="string">&quot;EVENT_&quot;</span>)[<span class="number">1</span>].lower() <span class="keyword">if</span> event <span class="keyword">else</span> <span class="literal">None</span> <span class="keyword">for</span> event <span class="keyword">in</span> df_events[<span class="string">&quot;type&quot;</span>]]</span><br><span class="line">```  </span><br><span class="line">该研究预先将数据存入了sql数据库，暂时我们不讨论有关数据库的调用，只看其提取过程，该部分首先抽取了数据库中指定时间片段的所有时间并存为dataframe，直接给出完整的查询语句：</span><br><span class="line">```SQL</span><br><span class="line">SELECT <span class="string">&quot;subject&quot;</span> <span class="keyword">as</span> subject, <span class="string">&quot;predicate_object&quot;</span> <span class="keyword">as</span> <span class="built_in">object</span>, <span class="string">&quot;uuid&quot;</span> <span class="keyword">as</span> event, <span class="string">&quot;type&quot;</span> ,<span class="string">&quot;time_stamp_nanos&quot;</span> <span class="keyword">as</span> timestamp</span><br><span class="line">FROM public.<span class="string">&quot;Event&quot;</span> </span><br><span class="line">WHERE <span class="string">&quot;time_stamp_nanos&quot;</span> BETWEEN  %(start_timestamp)s AND %(end_timestamp)s</span><br><span class="line">AND uuid IS NOT NULL AND <span class="string">&quot;subject&quot;</span> IS NOT NULL</span><br><span class="line">AND <span class="string">&quot;predicate_object&quot;</span> <span class="keyword">in</span> (</span><br><span class="line">    SELECT f.uuid </span><br><span class="line">    FROM public.<span class="string">&quot;FileObject&quot;</span> <span class="keyword">as</span> f INNER JOIN public.<span class="string">&quot;Event&quot;</span> <span class="keyword">as</span> e on f.uuid = e.predicate_object</span><br><span class="line">    WHERE time_stamp_nanos BETWEEN  %(start_timestamp)s AND %(end_timestamp)s</span><br><span class="line">    AND f.uuid IS NOT NULL AND prediacte_object_path IS NOT NULL AND prediacte_object_path != <span class="string">&#x27;&lt;unknown&gt;&#x27;</span></span><br><span class="line">    GROUP BY <span class="number">1</span></span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;NetflowObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;UnnamedPipeObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;SrcSinkObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;Subject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">SELECT <span class="string">&quot;subject&quot;</span> <span class="keyword">as</span> subject, <span class="string">&quot;predicate_object_2&quot;</span> <span class="keyword">as</span> <span class="built_in">object</span>,<span class="string">&quot;uuid&quot;</span> <span class="keyword">as</span> event ,<span class="string">&quot;type&quot;</span>,<span class="string">&quot;time_stamp_nanos&quot;</span> <span class="keyword">as</span> timestamp</span><br><span class="line">FROM public.<span class="string">&quot;Event&quot;</span></span><br><span class="line">WHERE <span class="string">&quot;time_stamp_nanos&quot;</span> BETWEEN  %(start_timestamp)s AND %(end_timestamp)s</span><br><span class="line">AND uuid IS NOT NULL AND <span class="string">&quot;subject&quot;</span> IS NOT NULL</span><br><span class="line">AND <span class="string">&quot;predicate_object_2&quot;</span> <span class="keyword">in</span> (</span><br><span class="line">    SELECT f.uuid </span><br><span class="line">    FROM public.<span class="string">&quot;FileObject&quot;</span> <span class="keyword">as</span> f INNER JOIN public.<span class="string">&quot;Event&quot;</span> <span class="keyword">as</span> e on f.uuid = e.predicate_object_2</span><br><span class="line">    WHERE time_stamp_nanos BETWEEN  %(start_timestamp)s AND %(end_timestamp)s</span><br><span class="line">    AND f.uuid IS NOT NULL AND predicate_object_path_2 IS NOT NULL AND predicate_object_path_2 != <span class="string">&#x27;&lt;unknown&gt;&#x27;</span></span><br><span class="line">    GROUP BY <span class="number">1</span></span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;NetflowObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;UnnamedPipeObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;SrcSinkObject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    UNION</span><br><span class="line">    SELECT DISTINCT <span class="string">&quot;uuid&quot;</span></span><br><span class="line">    FROM public.<span class="string">&quot;Subject&quot;</span> </span><br><span class="line">    WHERE uuid IS NOT NULL </span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>这个有一点复杂，简单来讲，就是抽取了买个uid和subject非空event的：<em>uid, sub, pobj, pobj2, type, timestamp</em>，其中pobj要求路径有效（为什么会有这个要求呢）。<br>
接下来，我们把它转化为python语句对json的筛选和汇总；顺便地，我们也要把里面其他的分类（除了host）整理出有效的信息来。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://example.com/2025/02/23/megr-apt-a-memory-efficient-apt-hunting-system-based-on-attack-representation-learning/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://example.com/2025/02/23/megr-apt-a-memory-efficient-apt-hunting-system-based-on-attack-representation-learning/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
